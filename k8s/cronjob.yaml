apiVersion: batch/v1
kind: CronJob
metadata:
  name: zombie-hunter-scan
  namespace: zombie-hunter
  labels:
    app.kubernetes.io/name: zombie-hunter
    app.kubernetes.io/component: scanner
spec:
  # Run daily at 2 AM UTC
  schedule: "0 2 * * *"
  
  # Timezone support (Kubernetes 1.27+)
  # timeZone: "UTC"
  
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 600
  
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      
      template:
        metadata:
          labels:
            app.kubernetes.io/name: zombie-hunter
            app.kubernetes.io/component: scanner
        spec:
          serviceAccountName: zombie-hunter
          restartPolicy: OnFailure
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
          
          containers:
            - name: zombie-hunter
              image: zombie-hunter:latest
              imagePullPolicy: IfNotPresent
              
              # Command to run scan with notifications
              command:
                - zombie-hunter
                - scan
                - --notify
                - --output
                - json
              
              # Resource limits
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              
              # Security context
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
              
              # Environment from secrets
              envFrom:
                - secretRef:
                    name: zombie-hunter-secrets
              
              # Additional environment variables
              env:
                - name: ZOMBIE_HUNTER_CONFIG_PATH
                  value: /app/config/config.yaml
                - name: ZOMBIE_HUNTER_DRY_RUN
                  value: "false"
                - name: ZOMBIE_HUNTER_LOG_LEVEL
                  value: "INFO"
              
              # Mount configuration
              volumeMounts:
                - name: config
                  mountPath: /app/config
                  readOnly: true
                - name: tmp
                  mountPath: /tmp
          
          volumes:
            - name: config
              configMap:
                name: zombie-hunter-config
            - name: tmp
              emptyDir: {}

---
# Optional: Deployment for interactive Slack handler
# Uncomment if you want always-on button interaction handling
# 
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: zombie-hunter-interactive
#   namespace: zombie-hunter
#   labels:
#     app.kubernetes.io/name: zombie-hunter
#     app.kubernetes.io/component: interactive
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app.kubernetes.io/name: zombie-hunter
#       app.kubernetes.io/component: interactive
#   template:
#     metadata:
#       labels:
#         app.kubernetes.io/name: zombie-hunter
#         app.kubernetes.io/component: interactive
#     spec:
#       serviceAccountName: zombie-hunter
#       containers:
#         - name: zombie-hunter
#           image: zombie-hunter:latest
#           command:
#             - zombie-hunter
#             - serve
#           envFrom:
#             - secretRef:
#                 name: zombie-hunter-secrets
#           env:
#             - name: ZOMBIE_HUNTER_CONFIG_PATH
#               value: /app/config/config.yaml
#           volumeMounts:
#             - name: config
#               mountPath: /app/config
#               readOnly: true
#           resources:
#             requests:
#               memory: "64Mi"
#               cpu: "50m"
#             limits:
#               memory: "256Mi"
#               cpu: "200m"
#       volumes:
#         - name: config
#           configMap:
#             name: zombie-hunter-config
